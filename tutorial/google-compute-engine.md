# Creating a Virtual Machine on Google Compute Engine

* Bertolt Sobolik (hid-sp18-419)
## Introduction

Google Compute Engine is an Infrastructure as a Service (IaaS)
offering from Google. The company offers a wide variety of virtual
machines, operating systems, and storage options to serve a wide
variety of customers, including many high-end options and
configurations designed for specific applications.

## Requirements

In order to create a VM on Google Compute Engine one must have a
Google Account. You can sign up for one
[here](https://accounts.google.com/SignUp?hl=en).

Next, you will need to [sign up for Google Cloud
Platform](https://console.cloud.google.com/freetrial). As of this
writing, Google is offering a free trial that includes $300 worth of
credits that expire one year from signup, but you will need to provide
billing information (either a credit card or bank details) to sign
up~\cite{hid-sp18-419-tutorial-gce-signup}.

When you sign up, Google will create a project for you called *My
First Project* with an autogenerated project ID. The page after the
welcome screen contains links to a number of easy to follow tutorials
and *Quick Starts* that will guide you through the steps required to
start various Google Cloud Platform services in the console.

## Automated Creation of a VM on Ubuntu 16.04

The following instructions are adapted from
[here](https://cloud.google.com/sdk/docs/quickstart-debian-ubuntu?authuser=1)~\cite{hid-sp18-419-tutorial-gce-setup}.

You will need to have *curl* installed. You can install it with:

```
sudo apt install curl
```


First you need to install the gcloud SDK: 

``` 
export CLOUD_SDK_REPO="cloud-sdk-$(lsb_release -c -s)" 
echo "deb http://packages.cloud.google.com/apt $CLOUD_SDK_REPO main" \
    | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list 
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg \
    | sudo apt-key add - 
sudo apt-get update && sudo apt-get install google-cloud-sdk 
```

Next, initialize the SDK with: 

``` 
gcloud init 
``` 

This will open a web browser and prompt you to log in to your account. 
If you don't have a browser installed or are doing a headless setup, 
you can use the following command instead: 

``` 
gcloud init --console-only 
```

This will display a link in your terminal that you must copy and paste
into a browser. The browser will return a verification code for you to
type into the terminal.

After you have logged in, the terminal will prompt you to select a
project or create a new one. Project IDs must be unique. If you pick
one like *test-vm* it will fail. If you start again with: 

```
gcloud init 
``` 

You will be prompted to pick up where you left off or
create a new configuration.

After selecting a project, you will be asked if you want to configure
a default Compute Region and Zone. If you do not, configuration is
complete.

## Create an Instance

You can create an instance with the following command (where <name of
instance> is the name of the instance you want to create): 

```
gcloud compute instances create <name of instance> 
```

If you have not set up a default Compute Region and Zone, you will be
prompted to select one from the 45 possibly zones, so it is probably
better to either set a default or decide which zone you want the
instance in before you type the command. For example, if you want to
create an instance called *foo* in *us-central1-a* (which is in Iowa),
you would enter:

```
gcloud compute instances create foo --zone=us-central-1a 
```

This will create an *n1-standard-1* instance with one CPU and 3.75 GB of
memory, which costs about $25 a month. If you leave it running, you
will burn through a lot of your free credits for nothing. You can stop
it with:

``` 
gcloud compute instances stop foo --zone=us-central-1a 
```

A full list of all the options for the **gcloud compute instances**
command is
[here](https://cloud.google.com/sdk/gcloud/reference/compute/instances/)~\cite{hid-sp18-419-tutorial-gce-reference}.

## Creating and Downloading Credentials for the Default Service Account
To create a service account, use the following command:
```
gcloud iam service-accounts create <account> 
```
A display name can be created for the account with the `--display-name` option.
The account created will be associated with an iam email address in the form: 
* `<account>@<project>.iam.gserveiceaccount.com`

To grant a `viewer` role to this account:

```
gcloud projects add-iam-policy-binding <project>\
    --member=serviceAccount:<account>@<project>.iam.gserviceaccount.com\
    --role=roles/viewer
```

To download credentials for this account use the command:
```
gcloud iam service-accounts keys create <file> --iam-account <iam email address>
```
followed by the name and path where you want the key (e.g. ~/key.json will create 
a file named `key.json` in the home directory. 

Google's documentation of the account creation process is [here](https://cloud.google.com/iam/docs/creating-managing-service-accounts).
Documentation of the key generation process is [here](https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
Accounts and keys can also be created on the Google Cloud Platform site or via the API.


